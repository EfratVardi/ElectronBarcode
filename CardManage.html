<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ממשק ניהול</title>
</head>

<body onload="onLoad()">
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link href="StyleSheets/CardManageStyleSheet.css" rel="stylesheet" />
    <link href="StyleSheets/MainStyleSheet.css" rel="stylesheet" />
    <script src="js/ag-grid-community.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="js/shared.js"></script>

    <script>
        var counter = 0;
        var uniqTasks = ""
        var systemConfig = ""
        var products = ""
        var students = "";
        var fileName
        var currentDate = getTodayDate();
        var gridOptions
        var columnDefs = [
            { headerName: "כיתה", field: "grade", editable: true },
            { headerName: "שם", field: "name", editable: true },
            { headerName: "תעודת זהות", field: "tz" },
            { headerName: "מספרי משימות", field: "tasksNumber", hide: true },
            { headerName: "נקודות", field: "points", editable: true },
            { headerName: "שמות המשימות", field: "tasks" }];

        function onLoad() {
            fileName = 'systemConfig'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data == 0) {
                    systemConfig = getDefaultConfig()
                }
                else {
                    systemConfig = JSON.parse(data)
                }
                if (systemConfig.color == "1") {
                    document.getElementById("background").style.backgroundImage = "url('resources/magnetCard/background.png')"
                }
                else if (systemConfig.color == "2") {
                    document.getElementById("background").style.backgroundImage = "url('resources/barcode/greenBackground4.gif')";
                }
                var swich = document.getElementById("swich");
                swich.checked = systemConfig.buy
                systemConfig.hasBuy == 1 ? swich.disabled = false : swich.disabled = true
                showLabel()
                fileName = 'uniqTasks'
                window.expose.SendExcel("sendReadExcel", fileName);
                window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                    if (data != 0) {
                        uniqTasks = JSON.parse(data)
                        fileName = 'products'
                        window.expose.SendExcel("sendReadExcel", fileName);
                        window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                            if (data != 0) {
                                products = JSON.parse(data)
                                createList()
                            }
                        })
                    }
                })
            });
            fileName = 'students'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data != 0) {
                    students = JSON.parse(data)
                    gridOptions = {
                        columnDefs: columnDefs,
                        rowData: students,
                        enableRtl: true,
                        defaultColDef: {
                            filter: 'agTextColumnFilter',
                            filterParams: {
                                suppressAndOrCondition: true
                            },
                            sortable: true,
                            resizable: true,
                        },
                        onFirstDataRendered: onFirstDataRendered,
                        onCellEditingStopped: onCellEditingStopped
                    };
                    var gridDiv = document.querySelector('#studentsGrid');
                    new agGrid.Grid(gridDiv, gridOptions);
                }
            });

        }

        document.addEventListener("keypress", function (e) {
            if (e.target.tagName !== "INPUT") {
                var input = document.querySelector(".my-input");
                input.focus();
                input.value = e.key;
                e.preventDefault();
            }
            counter += 1;
            if (counter > 9) {
                if (document.getElementById('barcode').value == '999999999')
                    login("Main")
                if (document.getElementById('barcode').value == '011429519')
                    login("System")
            }
        });

        function New() {
            if (students.length > 0) {
                var tz = Math.floor(Math.random() * (399999999 - 200000000 + 1) + 200000000)
                for (var i = 0; i < students.length; i++) {
                    while (students[i]["tz"] == tz) {
                        tz = Math.floor(Math.random() * (399999999 - 200000000 + 1) + 200000000)
                        i = 0
                    }
                }
                students.unshift({
                    grade: '------', name: '------', tz: tz, barcode: '',
                    points: 0, tasks: ",", tasksNumber: ","
                })
                fileName = 'students'
                window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(students)]);
                window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
                    location.reload()
                });
            }
        }

        function onFirstDataRendered(params) {
            gridOptions.api.sizeColumnsToFit({
                defaultMaxWidth: 150,
                columnLimits: [{ key: 'tasks', maxWidth: 500 }, { key: 'points', maxWidth: 100 }],
            });
        }

        function onCellEditingStopped(params) {
            fileName = 'students'
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(students)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
                location.reload()
            });
        }

        function Export(name) {
            var params = {
                fileName: currentDate + ' ' + name,
            };
            gridOptions.api.exportDataAsCsv(params);
        }

        function createList() {
            var checkboxList = document.getElementById("checkboxList");

            while (checkboxList.firstChild) {
                checkboxList.removeChild(checkboxList.firstChild);
            }

            let jsonData = ""
            var swich = document.getElementById("swich");
            if (swich.checked)
                jsonData = products
            else
                jsonData = uniqTasks

            // Iterate over the JSON data
            jsonData.forEach(function (item) {
                var li = document.createElement("li");
                li.classList.add("list-group-item");

                var input = document.createElement("input");
                input.classList.add("form-check-input", "me-1");
                input.type = "checkbox";
                input.id = item.code;
                input.checked = item.show

                var label = document.createElement("label");
                label.classList.add("form-check-label");
                label.setAttribute("for", item.id);
                label.textContent = item.name;

                input.addEventListener("change", function () {
                    updateShow(item.code); // Pass the code from the JSON object
                });

                li.appendChild(input);
                li.appendChild(label);
                checkboxList.appendChild(li);
            });

        }

        function swichChange() {
            createList()
            updateSystemConfig()
            showLabel()
        }

        function updateSystemConfig() {
            var swich = document.getElementById("swich");
            systemConfig.buy = swich.checked
            fileName = 'systemConfig'
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(systemConfig)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
            });
        }

        function updateShow(code) {
            let jsonData = ""
            var swich = document.getElementById("swich");
            if (swich.checked) {
                fileName = 'products'
                jsonData = products
            }
            else {
                fileName = 'uniqTasks'
                jsonData = uniqTasks
            }

            jsonData.forEach(function (item) {
                if (item.code == code) {
                    item.show = document.getElementById(code).checked;
                }
            })
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(jsonData)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
            });
        }
        
        function showLabel() {
            var swich = document.getElementById("swich");
            if (swich.checked)
                document.querySelector(".form-check-label").innerHTML = 'מצב קנייה פעיל';
            else
                document.querySelector(".form-check-label").innerHTML = 'מצב הגשת משימות פעיל';
        }
    </script>
    <div class="background" id="background">
        <div class="text">
            <div id="line1">ברוכה הבאה לממשק ניהול</div>
            <div id="line2">כאן אפשר לצפות, לערוך ולהוריד את הנתונים</div>
            <div class="row h-100">
                <div class="col-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="swich"
                            onchange="swichChange()">
                        <label class="form-check-label" for="swich">
                        </label>
                    </div>
                    <ul class="list-group" id="checkboxList">
                    </ul>
                </div>
                <div class="col-9">
                    <img onclick="Export('ניקוד תלמידות')" src="resources/barcode/download-simple-light.svg" />
                    <img onclick="New()" src="resources/barcode/plus-light.svg" />
                    <img onclick="expose.appClose()" src="resources/barcode/x-light.svg" />
                    <div id="studentsGrid" style="width:100%" class="ag-theme-alpine"></div>
                </div>
            </div>
        </div>
        <input type="text" class="my-input" id="barcode">
    </div>
</body>

</html>