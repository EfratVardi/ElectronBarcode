<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>צבירת נקודות</title>
    <style>
        @font-face {
            font-family: printFont;
            src: url("fonts/FbMagnolia-Regular.otf");
        }

        #title {
            font-family: printFont;
            direction: rtl;
            font-size: 40px;
        }

        #d1,
        #d2,
        #d3,
        #d4 {
            font-family: printFont;
            direction: rtl;
            font-size: 20px;
        }
    </style>
</head>

<body onload="onLoad()">
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link href="StyleSheets/UserStyleSheet.css" rel="stylesheet" />
    <link href="StyleSheets/MainStyleSheet.css" rel="stylesheet" />
    <script src="js/jquery.min.js"></script>
    <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="js/shared.js"></script>

    <script>
        var currentDate = getTodayDate();
        var uniqTasks = ""
        var systemConfig = ""
        var products = ""
        var students = ""
        var studentResult = ""
        var result = "";
        var searchVal
        var counter = 0;
        var state = 1
        var hasPrint = 1
        var buy = 0

        function onLoad() {
            fileName = 'systemConfig'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data == 0) {
                    systemConfig = getDefaultConfig()
                }
                else {
                    systemConfig = JSON.parse(data)
                }
                if (systemConfig.color == "1") {
                    document.getElementById("position").style.backgroundColor = "aquamarine";
                    document.getElementById("background").style.backgroundImage = "url('resources/barcode/pinkBackground1.gif')"
                }
                else if (systemConfig.color == "2") {
                    document.getElementById("position").style.backgroundColor = "yellow";
                    document.getElementById("background").style.backgroundImage = "url('resources/barcode/greenBackground1.gif')";
                }
                if (systemConfig.position.length > 0) {
                    document.getElementById("position").innerHTML += ' ' + systemConfig.position
                }
                else {
                    document.getElementById("position").style.display = "none";
                }
            })
            fileName = 'students'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data != 0) {
                    students = JSON.parse(data)
                    fileName = 'uniqTasks'
                    window.expose.SendExcel("sendReadExcel", fileName);
                    window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                        if (data != 0) {
                            uniqTasks = JSON.parse(data)
                            createCards()
                        }
                    })
                };
            });
            fileName = 'products'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data != 0) {
                    products = JSON.parse(data)
                };
            });
        }

        document.addEventListener("keypress", function (e) {
            if (e.target.tagName !== "INPUT") {
                var input = document.querySelector(".my-input");
                input.focus();
                input.value = e.key;
                e.preventDefault();
            }
            counter += 1;
            if (counter > 9 && state != 3) {
                searchVal = document.getElementById('barcode').value
                counter = 0;
                document.getElementById("barcode").value = "";
                if (searchVal == '999999999')
                    login('Manage')
                else if (searchVal == '011429519')
                    login('System')
                else if (searchVal == '207594581')
                    login('ParentsMeeting')
                else if (state == 2)//כיתה או בת
                    searchInExcel();
                else {
                    showAlert("קוד לא תקין!");
                    return;
                }
            }
            else if (counter > 9 && state == 3) {
                document.getElementById("barcode").value = ""
                counter = 0;
            }
        });

        function createCards() {
            const cardContainer = document.querySelector(".row");

            uniqTasks.forEach(cardData => {
                const cardColumn = document.createElement("div");
                cardColumn.classList.add("col-sm-2");

                const cardElement = document.createElement("div");
                cardElement.classList.add("card");

                const cardBody = document.createElement("div");
                cardBody.classList.add("card-body");

                const cardTitle = document.createElement("h5");
                cardTitle.classList.add("card-title");
                cardTitle.textContent = cardData.name + " " + cardData.points + ' נקודות'

                const button = document.createElement("input");
                button.classList.add("btn-check");
                button.name = "task"
                button.type = "radio"
                button.id = cardData.code
                button.addEventListener("click", function () {
                    selectAction(cardData.code); // Pass the code from the JSON object
                });

                const label = document.createElement("label");
                label.classList.add("btn", "btn-secondary");
                label.innerHTML = 'בחר'
                label.htmlFor = cardData.code

                cardBody.appendChild(cardTitle);
                cardBody.appendChild(button);
                cardBody.appendChild(label);
                cardElement.appendChild(cardBody);
                cardColumn.appendChild(cardElement);
                cardContainer.appendChild(cardColumn);
            });
        }

        function selectAction(code) {
            state = 2;
            for (var i = 0; i < uniqTasks.length; i++) {
                if (uniqTasks[i]["code"] == code) {
                    result = uniqTasks[i]
                    break;
                }
            }
            document.getElementById("line1").innerHTML = "בחרת במשימה: " + result.name;
            document.getElementById("line2").innerHTML = "יש להעביר את הרטיס המגנטי"
        }

        function searchInExcel() {
            state = 3
            for (var i = 0; i < students.length; i++) {
                if (students[i]["tz"] == searchVal) {
                    studentResult = students[i];
                    break;
                }
            }
            if (studentResult == "") {
                showAlert(" הברקוד לא מופיע ברשימות. גשו למורה!")
                return;
            }

            if (!result.multiple && studentResult.tasksNumber.includes(result.code)) {
                showAlert("הי, אסור להגיש משימה פעמיים!");
                return;
            }
            finishSession()
        }

        function finishSession() {
            studentResult.tasks += result.name + ',';
            studentResult.tasksNumber += result.code + ',';
            studentResult.points = parseInt(result.points) + parseInt(studentResult.points);
            if (studentResult.points < 0) {
                showAlert("אין לך מספיק נקודות בחשבון !")
                return;
            }
            saveData();
        }

        function saveData(points) {
            for (var i = 0; i < students.length; i++) {
                if (students[i]["tz"] == studentResult.tz) {
                    students[i] = studentResult;
                    break;
                }
            }
            fileName = 'students'
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(students)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
                document.getElementById("line1").innerHTML = studentResult.name;
                document.getElementById("line2").innerHTML = "! יש בחשבונך " + studentResult.points + " נקודות ";
                document.getElementById("line3").innerHTML = "!בהצלחה";
                if (hasPrint == 1)
                    setTimeout(function () {
                        toPrint();
                    }, 2000);
                else
                    reset(2000);
            });
        }

        function toPrint() {
            var divName = "printableArea";
            document.getElementById("d1").innerHTML = studentResult.name;
            document.getElementById("d2").innerHTML = studentResult.grade;
            if (buy == 1)
                document.getElementById("d3").innerHTML = "      משימה" + ": " + result.name;
            else
                document.getElementById("d3").innerHTML = "     זכאות למתנה" + ": " + result.name;
            document.getElementById("d4").innerHTML = "     נקודות בחשבון" + ": " + studentResult.points;
            var printContents = document.getElementById(divName).innerHTML;
            document.body.innerHTML = printContents;
            window.expose.send("sendPrint", "");
            window.expose.receive("receivePrint", (data) => {
                reset();
            });
        }

        function reset(time = 0) {
            setTimeout(function () {
                location.reload();
            }, time);
        }

        function showAlert(message) {
            document.querySelector(".modal-body").innerHTML = message;
            $(document).ready(function () {
                $('#modal').modal('show')
            });
            setTimeout(function () {
                $(document).ready(function () {
                    $('#modal').modal('hide')
                });
            }, 2500);
            reset(2500)
        }

    </script>
    <div id="printableArea" style="display: none;">
        <div id="title">אישור </div>
        <br />
        <div id="d1"> </div>
        <div id="d2"> </div>
        <div id="d3"> </div>
        <div id="d4"> </div>
        <br />
        <div id="title">בהצלחה!</div>
        <br /><br /><br /><br />
        <div id="d5" style="font-size:10px; font-family: Arial, Helvetica, sans-serif; direction: rtl;">להזמנות: אפרת
            מלכה
            0504167969 211efrat@gmail.com
        </div>
    </div>

    <div class="background" id="background">
        <div class="text">
            <div id="line1">!...שלום</div>
            <div id="line2">יש לבחור פעולה לביצוע</div>
            <div id="line3"></div>
            <br><br>
            <input type="text" class="my-input" id="barcode">
            <div class="row">
            </div>
            <div id="position">עמדה</div>
        </div>
        <div class="modal fade" style="direction: rtl" id="modal" tabindex="-1" role="dialog"
            aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">הודעת מערכת</h5>
                    </div>
                    <div class="modal-body"></div>
                </div>
            </div>
        </div>
</body>

</html>