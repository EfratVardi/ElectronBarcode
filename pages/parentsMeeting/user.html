<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>אסיפת הורים</title>
</head>

<body onload="onLoad()">
  <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
  <script src="../../js/jquery.min.js"></script>
  <script src="../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

  <script>
    var systemConfig = "";
    var parents = "";
    var searchVal = "";
    var step;
    var result = "";

    const Steps = {
      step1: "1",
      step2: "2",
      step3: "3"
    };

    function onLoad() {
      step = Steps.step1;
      window.expose.SendExcel("sendReadExcel", "systemConfig");
      window.expose.ReceiveExcel("receiveReadExcelsystemConfig", (data) => {
        systemConfig = data == 0 ? getDefaultConfig() : JSON.parse(data);

        window.expose.SendExcel("sendReadExcel", "parents");
        window.expose.ReceiveExcel("receiveReadExcelparents", (data) => {
          if (data != 0) {
            parents = JSON.parse(data);
          }
        });
      });
    }

    document.addEventListener("keypress", function (e) {
      if (e.key === "Enter" && searchVal.length > 0) {
        if (step == Steps.step1) {
          searchInExcel();
        }
      } else {
        searchVal += e.key;
      }
    });

    function searchInExcel() {
      result = parents.find(parent => parent.tz === searchVal || parent.tzParent === searchVal) || "";

      if (result === "") {
        showAlert("הברקוד לא מופיע ברשימות. גשו למורה!");
      } else {
        result.tz === searchVal ? studentStart() : parentStart();
      }
    }

    function parentStart() {
      step = Steps.step2;
      document.getElementById("line2").innerHTML = "שלום אמא של " + result.name;
      document.getElementById("line3").innerHTML = "כתבי כאן כמה מילים טובות לביתך";
      document.getElementById("form").style.display = "block";
    }

    function studentStart() {
      step = Steps.step2;
      document.getElementById("line2").innerHTML = "שלום " + result.name;
      document.getElementById("line3").innerHTML = "...המכתב מאמא מודפס עכשיו";
      setTimeout(() => toPrint(), 2500);
    }

    function saveData() {
      result.text = document.getElementById("content").value;
      const parentIndex = parents.findIndex(parent => parent.tzParent === result.tzParent);

      if (parentIndex > -1) {
        parents[parentIndex] = result;
      }

      window.expose.SendExcel("sendWriteExcel", ["parents", JSON.stringify(parents)]);
      window.expose.ReceiveExcel("receiveWriteExcelparents", () => {
        document.getElementById("form").style.display = "none";
        document.getElementById("line2").innerHTML = "!המכתב נשמר";
        document.getElementById("line3").innerHTML = "...תודה רבה על שיתוף הפעולה";
        reset(2000);
      });
    }

    function toPrint() {
      const dynamicHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8" />
        <title>Print</title>
        <style>
          body {
            font-family: 'Arial', sans-serif;
            direction: rtl;
            margin: 0;
            padding: 0;
          }
          #title {
            font-size: 40px;
            text-align: center;
          }
          #content div {
            font-size: 20px;
            margin: 10px 0;
          }
          #footer {
            font-size: 10px;
            text-align: center;
            margin-top: 20px;
          }
        </style>
      </head>
      <body>
        <div id="title">פתק מאמא</div>
        <br>
        <div id="content">
          <div>${result.name}</div>
          <div>${systemConfig.position}</div>
          <div>${result.text || "הנחת ממך בוודאי אשמע, את הדש תקבלי בפעם הבאה!"}</div>
        </div>
        <br>
        <div id="footer">להזמנות: אפרת מלכה 0504167969 211efrat@gmail.com</div>
      </body>
      </html>
      `;

      window.expose.send("sendPrint", dynamicHTML);
      window.expose.receive("receivePrint", () => {
        reset(2500);
      });
    }

    function reset(time = 0) {
      setTimeout(() => location.reload(), time);
    }

    function showAlert(message) {
      document.querySelector(".modal-body").innerHTML = message;
      $("#modal").modal("show");
      setTimeout(() => $("#modal").modal("hide"), 2500);
      reset(2500);
    }
  </script>

  <div id="text">
    <div id="line1">ברוכה הבאה</div>
    <div id="line2">אסיפת הורים תשפ"ד</div>
    <div id="line3">יש לתקף את הכרטיס האישי בסורק הברקוד</div>
    <form id="form" style="display: none; direction: rtl;">
      <textarea id="content" class="form-control" rows="6"></textarea>
      <button type="button" onclick="saveData()" id="btnSave" class="form-control">שמירת המכתב</button>
    </form>
  </div>

  <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">הודעת מערכת</h5>
        </div>
        <div class="modal-body"></div>
      </div>
    </div>
  </div>
</body>

</html>
