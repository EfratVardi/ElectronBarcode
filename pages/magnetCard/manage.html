<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ממשק ניהול</title>
</head>

<body>
    <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link href="../../styleSheets/cardManageStyleSheet.css" rel="stylesheet" />
    <link href="../../styleSheets/mainStyleSheet.css" rel="stylesheet" />
    <script src="../../js/ag-grid-community.min.js"></script>
    <script src="../../js/jquery.min.js"></script>
    <script src="../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../../js/shared.js"></script>

    <script>
        var uniqTasks = ""
        var systemConfig = ""
        var products = ""
        var students = "";
        var fileName
        var searchVal = ""
        var currentDate = getTodayDate();
        var swich
        var isInitialLoadTasks = true;
        var isInitialLoadProducts = true;

        var gridOptions
        var columnDefs = [
            { headerName: "כיתה", field: "grade" },
            { headerName: "שם", field: "name" },
            { headerName: "תעודת זהות", field: "tz" },
            { headerName: "נקודות", field: "points" }];

        var productsGridOptions
        var productsColumnDefs = [
            // { checkboxSelection: true },
            { headerName: "שם", field: "name", editable: true },
            { headerName: "נקודות", field: "points", editable: true },
            // {
            //     headerName: "תיקוף מרובה",
            //     field: "multiple",
            //     cellRenderer: function (params) {
            //         return `<input type="checkbox" ${params.value ? 'checked' : ''} />`;
            //     },
            //     cellEditor: 'agSelectCellEditor',
            //     cellEditorParams: {
            //         values: [0, 1]
            //     },
            //     editable: true,
            //     cellStyle: { textAlign: 'center' }
            // }
        ];

        window.addEventListener('DOMContentLoaded', () => {
            window.expose.getSystemSettings();
            window.expose.receiveSystemSettings((data) => {
                systemConfig = data
                document.getElementById("background").style.backgroundImage = "url('../../resources/barcode/personalBackground.png')"
                document.querySelector(".text").style.color = getTextColor(systemConfig.textColor);

                swich = document.getElementById("swich");
                swich_sec = document.getElementById("swich-sec");
                systemConfig.hasBuy != 1 ?
                    swich_sec.style.display = 'none' :
                    swich.checked = systemConfig.buy
                showLabel()

                if (systemConfig.hasBuy == 1) {
                    window.expose.getAllProducts();
                    window.expose.receiveAllProductsResponse((response) => {
                        if (response.success) {
                            products = response.products
                            createProductsGrid()
                        }
                    })
                }

                window.expose.getAllStudents();
                window.expose.receiveAllStudentsResponse((response) => {
                    if (response.success) {
                        students = response.students
                        createStudentsGrid()
                    }
                });
            })
        })

        document.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                if (searchVal.length > 0) {
                    if (searchVal == '999999999')
                        login("../main/user")
                    if (searchVal == '011429519')
                        login("../main/system")
                }
            } else {
                searchVal += e.key;
            }
        });

        function createProductsGrid() {
            productsGridOptions = {
                columnDefs: productsColumnDefs,
                rowData: products,
                enableRtl: true,
                rowSelection: 'multiple',
                suppressRowClickSelection: true,
                defaultColDef: {
                    sortable: true,
                },
                onCellClicked: cellClickedProduct,
                onCellEditingStopped: editProduct,
                onRowSelected: onProductsRowSelected,
                onFirstDataRendered: onProductsFirstRendered,
            };
            var productsGridDiv = document.querySelector('#productsGrid');
            new agGrid.Grid(productsGridDiv, productsGridOptions);
            document.getElementById("productsSec").style.visibility = "visible"
        }

        function createStudentsGrid() {
            gridOptions = {
                columnDefs: columnDefs,
                rowData: students,
                enableRtl: true,
                defaultColDef: {
                    filter: 'agTextColumnFilter',
                    filterParams: {
                        suppressAndOrCondition: true
                    },
                    sortable: true,
                    resizable: true
                },
                onFirstDataRendered: onStudentsFirstRendered,
                onCellEditingStopped: editStudent
            };
            var gridDiv = document.querySelector('#studentsGrid');
            new agGrid.Grid(gridDiv, gridOptions);
        }

        function onProductsFirstRendered(params) {
            productsGridOptions.api.sizeColumnsToFit({});
            productsGridOptions.api.forEachNode((node) => {
                if (node.data.show == true) {
                    node.setSelected(true);
                }
            });
            isInitialLoadProducts = false;
        }

        function onStudentsFirstRendered(params) {
            gridOptions.api.sizeColumnsToFit({
                columnLimits: [{ key: 'points', maxWidth: 100 }, { key: 'grade', maxWidth: 100 }],
            });
        }


        function cellClickedProduct(params) {
            if (params.colDef.field === 'multiple') {
                params.data.multiple = params.data.multiple === 1 ? 0 : 1;
                params.api.refreshCells({ rowNodes: [params.node] });
                editProduct()
            }
        }
        function editProduct(params) {
            const updatedField = params.colDef.field; // שם השדה שהתעדכן
            const updatedValue = params.value; // הערך החדש
            const productCode = params.data.code; // קוד המוצר של השורה

            if (updatedField === "name") {
                window.expose.updateProductName(productCode, updatedValue);
            } else if (updatedField === "points") {
                window.expose.updateProductPoints(productCode, updatedValue);
            }
        }

        function editStudent(params) {
            fileName = 'students'
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(students)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
            });
        }

        function onProductsRowSelected(event) {
            if (!isInitialLoadProducts) {
                event.node.data.show = event.node.isSelected();
                fileName = 'products'
                window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(products)]);
                window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
                });
            }
        }
        function generateRandomCode() {
            return Math.floor(100000000 + Math.random() * 900000000); // מספר בן 9 ספרות
        }
        function newProduct() {
            window.expose.insertProduct(generateRandomCode(), '------', 0, 1, 1);
            window.expose.receiveInsertProductResponse((response) => {
                if (response.success) {
                    location.reload()
                }
            })
        }

        function exportToExcel(name) {
            var params = {
                fileName: currentDate + ' ' + name,
            };
            gridOptions.api.exportDataAsCsv(params);
        }

        function swichChange() {
            updateSystemConfig()
            showLabel()
        }

        function updateSystemConfig() {
            window.expose.updateBuyStatus(swich.checked);
            window.expose.receiveUpdateBuyStatusResponse((response) => {
            });
        }

        function showLabel() {
            swich.checked ?
                document.querySelector(".form-check-label").innerHTML = 'מצב קנייה פעיל' :
                document.querySelector(".form-check-label").innerHTML = 'מצב צבירת נקודות פעיל';
        }

    </script>
    <div class="background" id="background">
        <div class="closeBtn">
            <img onclick="expose.appClose()" src="../../resources/barcode/x-light.svg" />
        </div>
        <div class="text">
            <div id="line1">ברוכים הבאים לממשק ניהול</div>
            <div id="line2">כאן אפשר לצפות, לערוך ולהוריד את הנתונים</div>
            <div class="row h-100">
                <div class="col-4 d-flex flex-column mb-4">
                    <div class="form-check form-switch mb-2" id="swich-sec">
                        <input class="form-check-input" type="checkbox" role="switch" id="swich"
                            onchange="swichChange()">
                        <label class="form-check-label" for="swich"></label>
                    </div>

                    <div id="productsSec" class="h-50 mb-2" style="text-align: right; visibility: hidden;">
                        <label> רשימת המוצרים</label>
                        <img onclick="newProduct()" src="../../resources/barcode/plus-light.svg"
                            class="cursor-pointer" />
                        <div id="productsGrid" class="ag-theme-alpine"></div>
                    </div>
                </div>
                <div class="col-8 d-flex flex-column mb-4">
                    <div style="text-align: right;">
                        <img onclick="exportToExcel('ניקוד תלמידות')"
                            src="../../resources/barcode/download-simple-light.svg" class="cursor-pointer" />
                        <!-- <img onclick="newStudent()" src="../../resources/barcode/plus-light.svg"
                            class="cursor-pointer" /> -->
                    </div>
                    <div id="studentsGrid" class="ag-theme-alpine w-100 h-100"></div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>