<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>תוכנית הברקודים</title>
</head>

<body onload="onLoad()">
  <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
  <link href="../../styleSheets/userStyleSheet.css" rel="stylesheet" />
  <link href="../../styleSheets/mainStyleSheet.css" rel="stylesheet" />
  <script src="../../js/jquery.min.js"></script>
  <script src="../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="../../js/shared.js"></script>

  <script>
    var currentDate = getTodayDate();
    var currentDateTime = getTodayDateTime();
    var students = ""
    var uniqTasks = ""
    var systemConfig = ""
    var searchVal = ""
    var buffer = "";
    var step
    var studentResult = ""
    var result = "";
    var fileName
    const Steps = {
      step1: "1",
      step2: "2",
      step3: "3"
    };
    var classesPoints = ""
    var defaultClassesPoints = [
      { "code": 100, "name": "כיתה ט", "points": 0 },
      { "code": 101, "name": "כיתה י", "points": 0 },
      { "code": 102, "name": "כיתה יא", "points": 0 },
      { "code": 102, "name": "כיתה יב", "points": 0 }]

    function onLoad() {
      classesPoints = JSON.parse(localStorage.getItem("classesPoints"));
      if (classesPoints == null) {
        localStorage.setItem("classesPoints", JSON.stringify(defaultClassesPoints));
        classesPoints = defaultClassesPoints;
      }
      step = Steps.step1;
      updateLines("!ברוכות הבאות","?...מי הכיתה המנצחת");
      fileName = 'systemConfig';
      window.expose.SendExcel("sendReadExcel", fileName);
      window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
        if (data == 0) {
          systemConfig = getDefaultConfig();
        } else {
          systemConfig = JSON.parse(data);
        }
        document.getElementById("background").style.backgroundImage = getBackground(systemConfig.device, systemConfig.color, step);
        document.querySelector(".text").style.color = getTextColor(systemConfig.textColor);
      });
      fileName = 'students';
      window.expose.SendExcel("sendReadExcel", fileName);
      window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
        if (data != 0) {
          students = JSON.parse(data);
        }
      });

      renderClassCards(); // Render cards for the classes
    }

    document.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        if (buffer.length > 0) {
          searchVal = buffer;
          buffer = "";
          if (step == Steps.step1) {
            if (searchVal == '999999999')
              login('../main/manage');
            else if (searchVal == '011429519')
              login('../main/system');
            else if (searchVal == '207594581')
              login('../parentsMeeting/user');
            else
              searchInExcel(); //בת
          }
        }
      } else {
        buffer += e.key;
      }
    });

    function searchInExcel() {
      step = Steps.step2;
      for (var i = 0; i < students.length; i++) {
        if (students[i]["tz"] == searchVal) {
          studentResult = students[i];
          break;
        }
      }
      if (studentResult == "") {
        showAlert("הברקוד לא מופיע ברשימות. גשו למורה!");
        return;
      }
      saveData();
    }

    function saveData() {
      for (var i = 0; i < classesPoints.length; i++) {
        if (classesPoints[i]["code"] == studentResult.class) {
          classesPoints[i]["points"] += 10;
          updateLines("(: כל הכבוד  " + classesPoints[i]["name"], "!עד כה צברתן " + classesPoints[i]["points"] + " נקודות");
          localStorage.setItem("classesPoints", JSON.stringify(classesPoints));
          renderClassCards(); 
          break;
        }
      }
      reset(2000);
    }

    function reset(time = 0) {
      setTimeout(function () {
        location.reload();
      }, time);
    }

    function updateLines(line1Text, line2Text, line3Text = "") {
      document.getElementById("line1").innerHTML = line1Text;
      document.getElementById("line2").innerHTML = line2Text;
      document.getElementById("line3").innerHTML = line3Text;
    }

    function showAlert(message) {
      document.querySelector(".modal-body").innerHTML = message;
      $(document).ready(function () {
        $('#modal').modal('show');
      });
      setTimeout(function () {
        $(document).ready(function () {
          $('#modal').modal('hide');
        });
        reset(0);
      }, 2500);
    }

    function renderClassCards() {
      const cardsContainer = document.getElementById('cards-container');
      cardsContainer.innerHTML = ''; // Clear existing cards
      classesPoints.forEach(classData => {
        const card = document.createElement('div');
        card.className = 'card m-2';
        card.style.width = '25rem';
        card.style.border = "solid"
        card.style.borderColor = "palevioletred"


        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title';
        cardTitle.textContent = classData.name;
        cardTitle.style.fontSize = '3vw';

        const cardText = document.createElement('p');
        cardText.className = 'card-text';
        cardText.className = 'blink-text';

        cardText.textContent = `${classData.points}`;
        cardText.style.fontSize = '4vw';
        cardText.style.color = "palevioletred"


        cardBody.appendChild(cardTitle);
        cardBody.appendChild(cardText);
        card.appendChild(cardBody);
        cardsContainer.appendChild(card);
      });
    }
  </script>

  <div class="background" id="background">
    <div class="text">
      <div id="line1"></div>
      <div id="line2"></div>
      <div id="line3"></div>
      <br>
      <div id="cards-container" class="d-flex flex-wrap justify-content-center mt-4" style="direction: rtl;"></div>
    </div>
  </div>

  <!-- Cards Container -->

  <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">הודעת מערכת</h5>
        </div>
        <div class="modal-body"></div>
      </div>
    </div>
  </div>
</body>

</html>